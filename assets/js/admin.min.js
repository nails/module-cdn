!function(e){var r={};function t(c){if(r[c])return r[c].exports;var n=r[c]={i:c,l:!1,exports:{}};return e[c].call(n.exports,n,n.exports,t),n.l=!0,n.exports}t.m=e,t.c=r,t.d=function(e,r,c){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:c})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var c=Object.create(null);if(t.r(c),Object.defineProperty(c,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var n in e)t.d(c,n,function(r){return e[r]}.bind(null,n));return c},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t(t.s=2)}([function(e,r,t){},,function(e,r,t){"use strict";t.r(r);t(0);class c{constructor(e){c.log("Constructing"),this.activePicker=null,this.objectCache=[],this.setupListeners(),e.onRefreshUi(()=>{this.initPickers()})}setupListeners(){c.log("Setting up listeners"),$(document).on("click",".cdn-object-picker",e=>{let r=$(e.currentTarget);return this.openManager(r),r.trigger("opened"),!1}).on("click",".cdn-object-picker .cdn-object-picker__remove",e=>{let r=$(e.currentTarget);return r.closest(".cdn-object-picker").trigger("removed"),this.resetPicker(r.closest(".cdn-object-picker")),!1}).on("click",".cdn-object-picker .cdn-object-picker__preview-link",e=>{let r=$(e.currentTarget);return $.fn.fancybox?(r.closest(".cdn-object-picker").trigger("preview"),$.fancybox.open(r.attr("href"),{helpers:{overlay:{locked:!1}}})):(r.closest(".cdn-object-picker").trigger("opened"),this.openManager(r.closest(".cdn-object-picker"))),!1}).on("refresh",".cdn-object-picker",e=>{let r=$(e.currentTarget);return this.refreshPicker(r),!1})}initPickers(){c.log("Processing new CDN Pickers"),this.refreshPicker($(".cdn-object-picker:not(.cdn-object-picker--pending):not(.cdn-object-picker--ready)"))}refreshPicker(e){let r=[];e.addClass("cdn-object-picker--pending"),e.addClass("cdn-object-picker--ready"),e.each((e,t)=>{let c=$(t),n=c.find(".cdn-object-picker__input").val();n?r.push(n):c.removeClass("cdn-object-picker--pending")}),r.length>0&&$.ajax({url:window.SITE_URL+"api/cdn/object",data:{ids:r.join(","),urls:"150x150-crop"}}).done(r=>{e.each((e,t)=>{let c=$(t),n=parseInt(c.find(".cdn-object-picker__input").val(),10);for(let e=r.data.length-1;e>=0;e--)if(n===r.data[e].id)return void this.setPickerObject(c,r.data[e])}),e.removeClass("cdn-object-picker--pending")}).fail(e=>{let r;try{r=JSON.parse(e.responseText)}catch(e){r={status:500,error:"An unknown error occurred."}}c.warn(r.error)})}setPickerObject(e,r){this.resetPicker(e),c.log("Setting picker object");let t=e.find(".cdn-object-picker__input"),n=this.getReadableFileSizeString(r.object.size.bytes),i=r.object.name,o=[n];t.val(r.id),r.is_img&&(e.addClass("cdn-object-picker--has-image"),e.find(".cdn-object-picker__preview-link").attr("href",r.url.src),e.find(".cdn-object-picker__preview").css({"background-image":"url("+r.url["150x150-crop"]+")"}),o.push(r.img.width+"x"+r.img.height)),i=i+" ("+o.join(", ")+")",e.addClass("cdn-object-picker--has-file"),e.find(".cdn-object-picker__label").html(i).attr("title",i),t.trigger("change"),e.trigger("picked")}resetPicker(e){c.log("Resetting picker"),e.removeClass("cdn-object-picker--has-image cdn-object-picker--has-file"),e.find(".cdn-object-picker__preview-link").attr("href","#"),e.find(".cdn-object-picker__preview").removeAttr("style"),e.find(".cdn-object-picker__label").html(""),e.find(".cdn-object-picker__input").val("").trigger("change"),e.trigger("reset")}openManager(e){if(e.data("readonly"))return!1;e.addClass("cdn-object-picker--pending"),c.log("Getting Manager URL"),$.ajax({url:window.SITE_URL+"api/cdn/manager/url",data:{bucket:e.data("bucket"),callback:['NAILS.ADMIN.instances["nails/module-cdn"].ObjectPicker',"receiveFromManager"]}}).done(r=>{$.fancybox?(c.log("Showing Manager"),this.activePicker=e,$("body").addClass("noscroll"),$.fancybox.open(r.data+"&isModal=1",{type:"iframe",width:"95%",height:"95%",iframe:{preload:!1},helpers:{overlay:{locked:!1}},beforeClose:function(){$("body").removeClass("noscroll")}})):c.warn("Fancybox not enabled.")}).fail(e=>{let r;try{r=JSON.parse(e.responseText)}catch(e){r={status:500,error:"An unknown error occurred."}}c.warn(r.error)}).always(()=>{e.removeClass("cdn-object-picker--pending")})}receiveFromManager(e){c.log("Received data from manager"),this.activePicker.addClass("cdn-object-picker--pending");let r=this.getFromCache(e);r?(c.log("Using Cache"),this.setPickerObject(this.activePicker,r),this.activePicker.removeClass("cdn-object-picker--pending"),this.activePicker=null):(c.log("Requesting Object data"),$.ajax({url:window.SITE_URL+"api/cdn/object",data:{id:e,urls:"150x150-crop"}}).done(e=>{this.setObjectCache(e.data),this.setPickerObject(this.activePicker,e.data)}).fail(e=>{let r;try{r=JSON.parse(e.responseText)}catch(e){r={status:500,error:"An unknown error occurred."}}c.warn(r.error)}).always(()=>{this.activePicker.removeClass("cdn-object-picker--pending"),this.activePicker=null}))}getReadableFileSizeString(e){let r=-1;do{e/=1024,r++}while(e>1024);return Math.max(e,.1).toFixed(1)+[" kB"," MB"," GB"," TB","PB","EB","ZB","YB"][r]}getFromCache(e){for(let r=this.objectCache.length-1;r>=0;r--)if(this.objectCache[r].id===e)return this.objectCache[r];return null}setObjectCache(e){this.objectCache.push(e)}static log(){"function"==typeof console.log&&console.log("[33m[CDN ObjectPicker][0m",...arguments)}static warn(){"function"==typeof console.warn&&console.warn("[33m[CDN ObjectPicker][0m",...arguments)}}var n=c;var i=class{constructor(){$("#cdn-orphan-search-form").length&&$("#cdn-orphan-search-form").on("submit",()=>{$("#cdn-orphan-search-mask").show()})}};window.NAILS.ADMIN.registerPlugin("nails/module-cdn","ObjectPicker",new n(window.NAILS.ADMIN)),window.NAILS.ADMIN.registerPlugin("nails/module-cdn","UtilitiesOrphans",new i)}]);
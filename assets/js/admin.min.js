(()=>{"use strict";window.NAILS.ADMIN.registerPlugin("nails/module-cdn","ObjectPicker",(function(e){return new class{constructor(e){this.adminController=e,this.adminController.log("Constructing"),this.activePicker=null,this.objectCache=[],this.setupListeners(),this.adminController.onRefreshUi((()=>{this.initPickers()}))}setupListeners(){this.adminController.log("Setting up listeners"),$(document).on("click",".cdn-object-picker",(e=>{let r=$(e.currentTarget);return this.openManager(r),r.trigger("opened"),!1})).on("click",".cdn-object-picker .cdn-object-picker__remove",(e=>{let r=$(e.currentTarget);return r.closest(".cdn-object-picker").trigger("removed"),this.resetPicker(r.closest(".cdn-object-picker")),!1})).on("click",".cdn-object-picker .cdn-object-picker__preview-link",(e=>{let r=$(e.currentTarget);return $.fn.fancybox?(r.closest(".cdn-object-picker").trigger("preview"),$.fancybox.open(r.attr("href"),{helpers:{overlay:{locked:!1}}})):(r.closest(".cdn-object-picker").trigger("opened"),this.openManager(r.closest(".cdn-object-picker"))),!1})).on("refresh",".cdn-object-picker",(e=>{let r=$(e.currentTarget);return this.refreshPicker(r),!1}))}initPickers(){this.adminController.log("Processing new CDN Pickers"),this.refreshPicker($(".cdn-object-picker:not(.cdn-object-picker--pending):not(.cdn-object-picker--ready)"))}refreshPicker(e){let r=[];e.addClass("cdn-object-picker--pending"),e.addClass("cdn-object-picker--ready"),e.each(((e,t)=>{let i=$(t),c=i.find(".cdn-object-picker__input").val();c?r.push(c):i.removeClass("cdn-object-picker--pending")})),r.length>0&&$.ajax({url:window.SITE_URL+"api/cdn/object",data:{ids:r.join(","),urls:"150x150-crop"}}).done((r=>{e.each(((e,t)=>{let i=$(t),c=parseInt(i.find(".cdn-object-picker__input").val(),10);for(let e=r.data.length-1;e>=0;e--)if(c===r.data[e].id)return void this.setPickerObject(i,r.data[e])})),e.removeClass("cdn-object-picker--pending")})).fail((e=>{let r;try{r=JSON.parse(e.responseText)}catch(e){r={status:500,error:"An unknown error occurred."}}this.adminController.warn(r.error)}))}setPickerObject(e,r){this.resetPicker(e),this.adminController.log("Setting picker object");let t=e.find(".cdn-object-picker__input"),i=this.getReadableFileSizeString(r.object.size.bytes),c=r.object.name,n=[i];t.val(r.id),r.is_img&&(e.addClass("cdn-object-picker--has-image"),e.find(".cdn-object-picker__preview-link").attr("href",r.url.src),e.find(".cdn-object-picker__preview").css({"background-image":"url("+r.url["150x150-crop"]+")"}),n.push(r.img.width+"x"+r.img.height)),c=c+" ("+n.join(", ")+")",e.addClass("cdn-object-picker--has-file"),e.find(".cdn-object-picker__label").html(c).attr("title",c),t.trigger("change"),e.trigger("picked")}resetPicker(e){this.adminController.log("Resetting picker"),e.removeClass("cdn-object-picker--has-image cdn-object-picker--has-file"),e.find(".cdn-object-picker__preview-link").attr("href","#"),e.find(".cdn-object-picker__preview").removeAttr("style"),e.find(".cdn-object-picker__label").html(""),e.find(".cdn-object-picker__input").val("").trigger("change"),e.trigger("reset")}openManager(e){if(e.data("readonly"))return!1;e.addClass("cdn-object-picker--pending"),this.adminController.log("Getting Manager URL"),$.ajax({url:window.SITE_URL+"api/cdn/manager/url",data:{bucket:e.data("bucket"),callback:['NAILS.ADMIN.instances["nails/module-cdn"].ObjectPicker',"receiveFromManager"]}}).done((r=>{$.fancybox?(this.adminController.log("Showing Manager"),this.activePicker=e,$("body").addClass("noscroll"),$.fancybox.open(r.data+"&isModal=1",{type:"iframe",width:"95%",height:"95%",iframe:{preload:!1},helpers:{overlay:{locked:!1}},beforeClose:function(){$("body").removeClass("noscroll")}})):this.adminController.warn("Fancybox not enabled.")})).fail((e=>{let r;try{r=JSON.parse(e.responseText)}catch(e){r={status:500,error:"An unknown error occurred."}}this.adminController.warn(r.error)})).always((()=>{e.removeClass("cdn-object-picker--pending")}))}receiveFromManager(e){this.adminController.log("Received data from manager"),this.activePicker.addClass("cdn-object-picker--pending");let r=this.getFromCache(e);r?(this.adminController.log("Using Cache"),this.setPickerObject(this.activePicker,r),this.activePicker.removeClass("cdn-object-picker--pending"),this.activePicker=null):(this.adminController.log("Requesting Object data"),$.ajax({url:window.SITE_URL+"api/cdn/object",data:{id:e,urls:"150x150-crop"}}).done((e=>{this.setObjectCache(e.data),this.setPickerObject(this.activePicker,e.data)})).fail((e=>{let r;try{r=JSON.parse(e.responseText)}catch(e){r={status:500,error:"An unknown error occurred."}}this.adminController.warn(r.error)})).always((()=>{this.activePicker.removeClass("cdn-object-picker--pending"),this.activePicker=null})))}getReadableFileSizeString(e){let r=-1;do{e/=1024,r++}while(e>1024);return Math.max(e,.1).toFixed(1)+[" kB"," MB"," GB"," TB","PB","EB","ZB","YB"][r]}getFromCache(e){for(let r=this.objectCache.length-1;r>=0;r--)if(this.objectCache[r].id===e)return this.objectCache[r];return null}setObjectCache(e){this.objectCache.push(e)}}(e)}))})();
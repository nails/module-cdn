!function(e){var t={};function r(c){if(t[c])return t[c].exports;var i=t[c]={i:c,l:!1,exports:{}};return e[c].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,c){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:c})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var c=Object.create(null);if(r.r(c),Object.defineProperty(c,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(c,i,function(t){return e[t]}.bind(null,i));return c},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=2)}([function(e,t,r){},,function(e,t,r){"use strict";r.r(t);r(0);var c=class{constructor(){this.log("Constructing"),this.activePicker=null,this.objectCache=[],this.setupListeners(),this.initPickers()}setupListeners(){this.log("Setting up listeners"),$(document).on("click",".cdn-object-picker",e=>{let t=$(e.currentTarget);return this.openManager(t),t.trigger("opened"),!1}).on("click",".cdn-object-picker .cdn-object-picker__remove",e=>{let t=$(e.currentTarget);return t.closest(".cdn-object-picker").trigger("removed"),this.resetPicker(t.closest(".cdn-object-picker")),!1}).on("click",".cdn-object-picker .cdn-object-picker__preview-link",e=>{let t=$(e.currentTarget);return $.fn.fancybox?(t.closest(".cdn-object-picker").trigger("preview"),$.fancybox.open(t.attr("href"),{helpers:{overlay:{locked:!1}}})):(t.closest(".cdn-object-picker").trigger("opened"),this.openManager(t.closest(".cdn-object-picker"))),!1}).on("refresh",".cdn-object-picker",e=>{let t=$(e.currentTarget);return this.refreshPicker(t),!1})}initPickers(){this.log("Processing new CDN Pickers"),this.refreshPicker($(".cdn-object-picker:not(.cdn-object-picker--pending)"))}refreshPicker(e){let t=[];e.each((e,r)=>{let c=$(r);c.addClass("cdn-object-picker--pending");let i=c.find(".cdn-object-picker__input").val();i?t.push(i):c.removeClass("cdn-object-picker--pending")}),t.length>0&&$.ajax({url:window.SITE_URL+"api/cdn/object",data:{ids:t.join(","),urls:"150x150-crop"}}).done(t=>{e.each((e,r)=>{let c=$(r),i=parseInt(c.find(".cdn-object-picker__input").val(),10);for(let e=t.data.length-1;e>=0;e--)if(i===t.data[e].id)return void this.setPickerObject(c,t.data[e])}),e.removeClass("cdn-object-picker--pending")}).fail(e=>{let t;try{t=JSON.parse(e.responseText)}catch(e){t={status:500,error:"An unknown error occurred."}}this.warn(t.error)})}setPickerObject(e,t){this.resetPicker(e),this.log("Setting picker object");let r=e.find(".cdn-object-picker__input"),c=this.getReadableFileSizeString(t.object.size.bytes),i=t.object.name,n=[c];r.val(t.id),t.is_img&&(e.addClass("cdn-object-picker--has-image"),e.find(".cdn-object-picker__preview-link").attr("href",t.url.src),e.find(".cdn-object-picker__preview").css({"background-image":"url("+t.url["150x150-crop"]+")"}),n.push(t.img.width+"x"+t.img.height)),i=i+" ("+n.join(", ")+")",e.addClass("cdn-object-picker--has-file"),e.find(".cdn-object-picker__label").html(i).attr("title",i),r.trigger("change"),e.trigger("picked")}resetPicker(e){this.log("Resetting picker"),e.removeClass("cdn-object-picker--has-image cdn-object-picker--has-file"),e.find(".cdn-object-picker__preview-link").attr("href","#"),e.find(".cdn-object-picker__preview").removeAttr("style"),e.find(".cdn-object-picker__label").html(""),e.find(".cdn-object-picker__input").val("").trigger("change"),e.trigger("reset")}openManager(e){if(e.data("readonly"))return!1;e.addClass("cdn-object-picker--pending"),this.log("Getting Manager URL"),$.ajax({url:window.SITE_URL+"api/cdn/manager/url",data:{bucket:e.data("bucket"),callback:["NAILS.CDN.ObjectPicker","receiveFromManager"]}}).done(t=>{$.fancybox?(this.log("Showing Manager"),this.activePicker=e,$("body").addClass("noscroll"),$.fancybox.open(t.data+"&isModal=1",{type:"iframe",width:"95%",height:"95%",iframe:{preload:!1},helpers:{overlay:{locked:!1}},beforeClose:function(){$("body").removeClass("noscroll")}})):this.warn("Fancybox not enabled.")}).fail(e=>{let t;try{t=JSON.parse(e.responseText)}catch(e){t={status:500,error:"An unknown error occurred."}}this.warn(t.error)}).always(()=>{e.removeClass("cdn-object-picker--pending")})}receiveFromManager(e){this.log("Received data from manager"),this.activePicker.addClass("cdn-object-picker--pending");let t=this.getFromCache(e);t?(this.log("Using Cache"),this.setPickerObject(this.activePicker,t),this.activePicker.removeClass("cdn-object-picker--pending"),this.activePicker=null):(this.log("Requesting Object data"),$.ajax({url:window.SITE_URL+"api/cdn/object",data:{id:e,urls:"150x150-crop"}}).done(e=>{this.setObjectCache(e.data),this.setPickerObject(this.activePicker,e.data)}).fail(e=>{let t;try{t=JSON.parse(e.responseText)}catch(e){t={status:500,error:"An unknown error occurred."}}this.warn(t.error)}).always(()=>{this.activePicker.removeClass("cdn-object-picker--pending"),this.activePicker=null}))}getReadableFileSizeString(e){let t=-1;do{e/=1024,t++}while(e>1024);return Math.max(e,.1).toFixed(1)+[" kB"," MB"," GB"," TB","PB","EB","ZB","YB"][t]}getFromCache(e){for(let t=this.objectCache.length-1;t>=0;t--)if(this.objectCache[t].id===e)return this.objectCache[t];return null}setObjectCache(e){this.objectCache.push(e)}log(e,t){"function"==typeof console.log&&(void 0!==t?console.log("CDN Object Picker:",e,t):console.log("CDN Object Picker:",e))}warn(e,t){"function"==typeof console.warn&&(void 0!==t?console.warn("CDN Object Picker:",e,t):console.warn("CDN Object Picker:",e))}};var i=class{constructor(){$("#cdn-orphan-search-form").length&&$("#cdn-orphan-search-form").on("submit",()=>{$("#cdn-orphan-search-mask").show()})}};window.NAILS.CDN={ObjectPicker:new c},new i}]);
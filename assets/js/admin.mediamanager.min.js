function MediaManager(e,t,r,n){var o=this;return o.ready=ko.observable(!1),o.buckets=ko.observableArray(),o.objects=ko.observableArray(),o.currentBucket=ko.observable(),o.currentPage=ko.observable(1),o.showLoadMore=ko.observable(!1),o.showAddBucket=ko.observable(!1),o.droppable=ko.observable(!1),o.showInsert=ko.observable(r.length>0),o.canUpload=ko.observable(!0),o.isSearching=ko.observable(!1),o.searchTimeout=null,o.searchTerm=ko.observable(),o.lastSearch=ko.observable(),o.isTrash=ko.observable(!1),o.keymap={ENTER:13,ESC:27},o.__construct=function(){return o.debug("Constructing"),o.init(),o},o.init=function(){var t=new $.Deferred;return t.done(function(){o.debug("Initialisation complete"),o.buckets().length>0?o.listObjects().done(function(){t.resolve(),o.ready(!0)}).fail(function(){}):(t.resolve(),o.ready(!0))}).fail(function(){o.debug("Initialisation failed")}),o.debug("Initialising"),o.listBuckets().done(function(){if(e){o.debug("Initial bucket specified, attempting to load");var r=o.getBucketBySlug(e);if(r)o.debug("Initial bucket is valid, resolving"),o.currentBucket(r.id),t.resolve();else{o.debug("Initial bucket not found, attempting to create");var n=e;n=n.replace(/[_-]/g," "),n=n.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}),$.ajax({url:window.SITE_URL+"api/cdn/bucket",method:"POST",data:{label:n}}).fail(function(){o.debug("Failed to create initial bucket"),t.reject()}).done(function(e){o.debug("Initial bucket created, listing again..."),o.currentBucket(e.data.id),o.listBuckets().done(function(){t.resolve()})})}}else o.buckets().length>0?(o.currentBucket(o.buckets()[0].id),t.resolve()):t.resolve()}),t.promise()},o.addBucket=function(e){o.debug("Adding bucket:"+e.label),o.buckets.push({id:e.id||null,slug:e.slug||null,label:e.label||null,max_size:e.max_size||null,max_size_human:e.max_size_human||null,is_selected:ko.computed(function(){return!o.isSearching()&&!o.isTrash()&&e.id===o.currentBucket()})})},o.selectBucket=function(e){"object"==typeof e?o.currentBucket(e.id):o.currentBucket(e),o.isSearching(!1),o.lastSearch(""),o.searchTerm(""),o.canUpload(!0),o.isTrash(!1),o.currentPage(1),o.objects.removeAll(),o.listObjects()},o.createBucket=function(e,t){return t.which===o.keymap.ENTER?$.ajax({url:window.SITE_URL+"api/cdn/bucket",method:"POST",data:{label:t.currentTarget.value}}).done(function(e){o.showAddBucket(!1),o.listBuckets(),o.selectBucket(e.data.id),o.success("Bucket created")}).fail(function(e){o.error("Failed to create bucket.",e)}):t.which===o.keymap.ESC&&o.showAddBucket(!1),!0},o.uploadObject=function(e,t){return $.each(t.currentTarget.files,function(e,t){var r=o.addObject({label:t.name,is_uploading:!0},!0),n=o.getBucketById(o.currentBucket());if(!n)return r.error("Unable to determine upload bucket."),!1;if(n.max_size&&t.size>n.max_size)return r.error("File is too big; maximum file size for this bucket is "+n.max_size_human),!1;var a=new XMLHttpRequest;a.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=Math.floor(e.loaded/e.total*100);r.upload_progress(t)}},!1),a.addEventListener("error",function(){r.error("An error occurred whilst uploading the file.")},!1),a.addEventListener("load",function(e){if(4===e.currentTarget.readyState){var t;if(200===e.currentTarget.status){try{t=JSON.parse(e.currentTarget.responseText)}catch(e){t={error:"An unknown error occurred."}}r.id=t.object.id,r.label=t.object.object.name,r.ext=r.label.substr(r.label.lastIndexOf(".")+1),r.url={src:t.object.url.src,preview:t.object.is_img?t.object.url["400x400-crop"]:null},r.is_img=t.object.is_img,r.is_uploading(!1)}else{try{t=JSON.parse(e.currentTarget.responseText)}catch(e){t={error:"An unknown error occurred."}}r.error(t.error)}}},!1),a.open("post",window.SITE_URL+"api/cdn/object/create",!0),a.setRequestHeader("X-Cdn-Bucket",n.slug),a.setRequestHeader("X-Cdn-Urls","400x400-crop");var c=new FormData;c.append("upload",t),a.send(c)}),t.currentTarget.value=null,o.droppable(!1),!0},o.deleteObject=function(){var e=this;if(e.id){var t="Are you sure?";o.isTrash()&&(t+=" You cannot undo this action."),confirm(t)&&$.ajax({url:window.SITE_URL+"api/cdn/object/delete",method:"POST",data:{object_id:e.id}}).done(function(){o.objects.remove(e),o.success("Item deleted")}).fail(function(){o.error("Failed to delete object. It may be in use.")})}else o.objects.remove(e)},o.restoreObject=function(){var e=this;$.ajax({url:window.SITE_URL+"api/cdn/object/restore",method:"POST",data:{object_id:e.id}}).done(function(){o.objects.remove(e),o.success("Item restored")}).fail(function(){o.error("Failed to restore object.")})},o.executeCallback=function(){"ckeditor"===t?(o.callbackCKEditor(this),window.close()):(o.callbackPicker(this),window.parent.$.fancybox.close())},o.callbackCKEditor=function(e){window.opener.CKEDITOR.tools.callFunction(r[0],e.url.src)},o.callbackPicker=function(e){n?window.parent[r[0]][r[1]].call(null,e.id):window.opener[r[0]][r[1]].call(null,e.id)},o.addObject=function(e,t){o.debug("Adding object");var r={id:e.id||null,label:e.label||null,ext:e.ext||null,url:e.url||null,is_img:e.is_img||null,is_uploading:ko.observable(e.is_uploading||!1),upload_progress:ko.observable(0),error:ko.observable()};return t?o.objects.unshift(r):o.objects.push(r),r},o.listBuckets=function(){o.debug("Listing buckets");var e=new $.Deferred;return $.ajax({url:window.SITE_URL+"api/cdn/bucket"}).done(function(t){o.buckets.removeAll(),$.each(t.data,function(e,t){o.addBucket(t)}),e.resolve()}).fail(function(){o.error("Failed to retrieve list of buckets from the server."),e.reject()}),e.promise()},o.getBucketById=function(e){for(var t=0,r=o.buckets().length;t<r;t++)if(o.buckets()[t].id===e)return o.buckets()[t];return null},o.getBucketBySlug=function(e){for(var t=0,r=o.buckets().length;t<r;t++)if(o.buckets()[t].slug===e)return o.buckets()[t];return null},o.listObjects=function(){o.debug("Listing objects");var e,t,r=new $.Deferred;return o.isSearching()?(e=window.SITE_URL+"api/cdn/object/search",t={keywords:o.searchTerm(),page:o.currentPage()}):o.isTrash()?(e=window.SITE_URL+"api/cdn/object/trash",t={page:o.currentPage()}):(e=window.SITE_URL+"api/cdn/bucket/list",t={bucket_id:o.currentBucket(),page:o.currentPage()}),$.ajax({url:e,data:t}).done(function(e){$.each(e.data,function(e,t){o.addObject({id:t.id||null,label:t.file.name.human||null,size:t.file.size.human||null,ext:t.file.ext||null,url:t.url||null,is_img:t.is_img||!1})}),o.currentPage(e.meta.page+1),o.showLoadMore(e.data.length>=e.meta.per_page),r.resolve()}).fail(function(){o.error("Failed to retrieve list of objects from the server."),r.reject()}),r.promise()},o.search=function(){return clearTimeout(o.searchTimeout),o.searchTimeout=setTimeout(function(){var e=$.trim(o.searchTerm());e.length?e!==o.lastSearch()&&(o.isSearching(!0),o.isTrash(!1),o.canUpload(!1),o.lastSearch(e),o.objects.removeAll(),o.currentPage(1),o.listObjects()):o.stopSearch()},150),!0},o.stopSearch=function(){o.isSearching(!1),o.canUpload(!0),o.currentPage(1),o.objects.removeAll(),o.listObjects()},o.browseTrash=function(){o.canUpload(!1),o.isSearching(!1),o.lastSearch(""),o.searchTerm(""),o.isTrash(!0),o.currentPage(1),o.objects.removeAll(),o.listObjects()},o.feedback=function(e,t){o.debug("Feedback: "+e+": "+t);var r=new $.Deferred,n=$(".manager-feedback__"+e);return n.html(t).addClass("show"),setTimeout(function(){o.debug("Closing feedback: "+e),r.resolve(),n.removeClass("show")},2500),r.promise()},o.success=function(e){return o.feedback("success",e)},o.error=function(e){return o.feedback("error",e||"An unknown error occurred.")},o.debug=function(e){return"object"==typeof console&&console.log("[Media Manager] ",e),o},o.__construct()}
//# sourceMappingURL=admin.mediamanager.min.js.map

function MediaManager(e,t,r,n){var a=this;return a.ready=ko.observable(!1),a.buckets=ko.observableArray(),a.objects=ko.observableArray(),a.currentBucket=ko.observable(),a.currentPage=ko.observable(1),a.showLoadMore=ko.observable(!1),a.showAddBucket=ko.observable(!1),a.droppable=ko.observable(!1),a.showInsert=ko.observable(r.length>0),a.canUpload=ko.observable(!0),a.isSearching=ko.observable(!1),a.searchTimeout=null,a.searchTerm=ko.observable(),a.lastSearch=ko.observable(),a.isTrash=ko.observable(!1),a.keymap={ENTER:13,ESC:27},a.__construct=function(){return a.debug("Constructing"),a.init(),a},a.init=function(){var t=new $.Deferred;return t.done(function(){a.debug("Initialisation complete"),a.buckets().length>0?a.listObjects().done(function(){t.resolve(),a.ready(!0)}).fail(function(){}):(t.resolve(),a.ready(!0))}).fail(function(){a.debug("Initialisation failed")}),a.debug("Initialising"),a.listBuckets().done(function(){if(e){a.debug("Initial bucket specified, attempting to load");var r=a.getBucketBySlug(e);if(r)a.debug("Initial bucket is valid, resolving"),a.currentBucket(r.id),t.resolve();else{a.debug("Initial bucket not found, attempting to create");var n=e;n=n.replace(/[_-]/g," "),n=n.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}),$.ajax({url:window.SITE_URL+"api/cdn/bucket",method:"POST",data:{label:n}}).fail(function(){a.debug("Failed to create initial bucket"),t.reject()}).done(function(e){a.debug("Initial bucket created, listing again..."),a.currentBucket(e.data.id),a.listBuckets().done(function(){t.resolve()})})}}else a.buckets().length>0?(a.currentBucket(a.buckets()[0].id),t.resolve()):t.resolve()}),t.promise()},a.addBucket=function(e){a.debug("Adding bucket:"+e.label),a.buckets.push({id:e.id||null,slug:e.slug||null,label:e.label||null,max_size:e.max_size||null,max_size_human:e.max_size_human||null,object_count:e.object_count||0,is_selected:ko.computed(function(){return!a.isSearching()&&!a.isTrash()&&e.id===a.currentBucket()})})},a.selectBucket=function(e){"object"==typeof e?a.currentBucket(e.id):a.currentBucket(e),a.isSearching(!1),a.lastSearch(""),a.searchTerm(""),a.canUpload(!0),a.isTrash(!1),a.currentPage(1),a.objects.removeAll(),a.listObjects()},a.createBucket=function(e,t){return t.which===a.keymap.ENTER?$.ajax({url:window.SITE_URL+"api/cdn/bucket",method:"POST",data:{label:t.currentTarget.value}}).done(function(e){a.showAddBucket(!1),a.listBuckets(),a.selectBucket(e.data.id),a.success("Bucket created")}).fail(function(e){a.error("Failed to create bucket.",e)}):t.which===a.keymap.ESC&&a.showAddBucket(!1),!0},a.uploadObject=function(e,t){return $.each(t.currentTarget.files,function(e,t){var r=a.addObject({label:t.name,is_uploading:!0},!0),n=a.getBucketById(a.currentBucket());if(!n)return r.error("Unable to determine upload bucket."),!1;if(n.max_size&&t.size>n.max_size)return r.error("File is too big; maximum file size for this bucket is "+n.max_size_human),!1;var o=new XMLHttpRequest;o.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=Math.floor(e.loaded/e.total*100);r.upload_progress(t)}},!1),o.addEventListener("error",function(){r.error("An error occurred whilst uploading the file.")},!1),o.addEventListener("load",function(e){if(4===e.currentTarget.readyState){var t;if(200===e.currentTarget.status)try{t=JSON.parse(e.currentTarget.responseText),r.id=t.data.object.id,r.label=t.data.object.object.name,r.ext=r.label.substr(r.label.lastIndexOf(".")+1),r.url={src:t.data.object.url.src,preview:t.data.object.is_img?t.data.object.url["400x400-crop"]:null},r.is_img=t.data.object.is_img,r.is_uploading(!1)}catch(e){t={error:"An unknown error occurred."},r.error(t.error)}else{try{t=JSON.parse(e.currentTarget.responseText)}catch(e){t={error:"An unknown error occurred."}}r.error(t.error)}}},!1),o.open("post",window.SITE_URL+"api/cdn/object/create",!0),o.setRequestHeader("X-Cdn-Bucket",n.slug),o.setRequestHeader("X-Cdn-Urls","400x400-crop");var c=new FormData;c.append("upload",t),o.send(c)}),t.currentTarget.value=null,a.droppable(!1),!0},a.deleteObject=function(){var e=this;if(e.id){var t="Are you sure?";a.isTrash()&&(t+=" You cannot undo this action."),confirm(t)&&$.ajax({url:window.SITE_URL+"api/cdn/object/delete",method:"POST",data:{object_id:e.id}}).done(function(){a.objects.remove(e),a.success("Item deleted")}).fail(function(){a.error("Failed to delete object. It may be in use.")})}else a.objects.remove(e)},a.restoreObject=function(){var e=this;$.ajax({url:window.SITE_URL+"api/cdn/object/restore",method:"POST",data:{object_id:e.id}}).done(function(){a.objects.remove(e),a.success("Item restored")}).fail(function(){a.error("Failed to restore object.")})},a.executeCallback=function(){"ckeditor"===t?(a.callbackCKEditor(this),window.close()):(a.callbackPicker(this),window.parent.$.fancybox.close())},a.callbackCKEditor=function(e){window.opener.CKEDITOR.tools.callFunction(r[0],e.url.src)},a.callbackPicker=function(e){n?window.parent[r[0]][r[1]].call(null,e.id):window.opener[r[0]][r[1]].call(null,e.id)},a.addObject=function(e,t){a.debug("Adding object");var r={id:e.id||null,label:e.label||null,ext:e.ext||null,url:e.url||null,is_img:e.is_img||null,is_uploading:ko.observable(e.is_uploading||!1),upload_progress:ko.observable(0),error:ko.observable()};return t?a.objects.unshift(r):a.objects.push(r),r},a.listBuckets=function(){a.debug("Listing buckets");var e=new $.Deferred;return a.apiFetchBuckets(window.SITE_URL+"api/cdn/bucket").done(function(t){a.buckets.removeAll(),$.each(t,function(e,t){a.addBucket(t)}),e.resolve()}).fail(function(){a.error("Failed to retrieve list of buckets from the server."),e.reject()}),e.promise()},a.apiFetchBuckets=function(e,t){var r=new $.Deferred;return"undefined"==typeof t&&(t=[]),a.debug("Calling: "+e),$.ajax({url:e}).done(function(e){$.each(e.data,function(e,r){t.push(r)}),e.meta.pagination.next&&a.apiFetchBuckets(e.meta.pagination.next,t).done(function(){r.resolve()}).fail(function(){r.reject()}),r.resolve(t)}).fail(function(e){a.error("Failed to retrieve list of buckets from the server."),r.reject()}),r.promise()},a.getBucketById=function(e){for(var t=0,r=a.buckets().length;t<r;t++)if(a.buckets()[t].id===e)return a.buckets()[t];return null},a.getBucketBySlug=function(e){for(var t=0,r=a.buckets().length;t<r;t++)if(a.buckets()[t].slug===e)return a.buckets()[t];return null},a.listObjects=function(){a.debug("Listing objects");var e,t,r=new $.Deferred;return a.isSearching()?(e=window.SITE_URL+"api/cdn/object/search",t={keywords:a.searchTerm(),page:a.currentPage()}):a.isTrash()?(e=window.SITE_URL+"api/cdn/object/trash",t={page:a.currentPage()}):(e=window.SITE_URL+"api/cdn/bucket/list",t={bucket_id:a.currentBucket(),page:a.currentPage()}),$.ajax({url:e,data:t}).done(function(e){$.each(e.data,function(e,t){a.addObject({id:t.id||null,label:t.file.name.human||null,size:t.file.size.human||null,ext:t.file.ext||null,url:t.url||null,is_img:t.is_img||!1})}),a.currentPage(e.meta.page+1),a.showLoadMore(e.data.length>=e.meta.per_page),r.resolve()}).fail(function(){a.error("Failed to retrieve list of objects from the server."),r.reject()}),r.promise()},a.search=function(){return clearTimeout(a.searchTimeout),a.searchTimeout=setTimeout(function(){var e=$.trim(a.searchTerm());e.length?e!==a.lastSearch()&&(a.isSearching(!0),a.isTrash(!1),a.canUpload(!1),a.lastSearch(e),a.objects.removeAll(),a.currentPage(1),a.listObjects()):a.stopSearch()},150),!0},a.stopSearch=function(){a.isSearching(!1),a.canUpload(!0),a.currentPage(1),a.objects.removeAll(),a.listObjects()},a.browseTrash=function(){a.canUpload(!1),a.isSearching(!1),a.lastSearch(""),a.searchTerm(""),a.isTrash(!0),a.currentPage(1),a.objects.removeAll(),a.listObjects()},a.feedback=function(e,t){a.debug("Feedback: "+e+": "+t);var r=new $.Deferred,n=$(".manager-feedback__"+e);return n.html(t).addClass("show"),setTimeout(function(){a.debug("Closing feedback: "+e),r.resolve(),n.removeClass("show")},2500),r.promise()},a.success=function(e){return a.feedback("success",e)},a.error=function(e){return a.feedback("error",e||"An unknown error occurred.")},a.debug=function(e){return"object"==typeof console&&console.log("[Media Manager] ",e),a},a.__construct()}
//# sourceMappingURL=admin.mediamanager.min.js.map

function MediaManager(e,t,r,a){var n=this;return n.ready=ko.observable(!1),n.buckets=ko.observableArray(),n.objects=ko.observableArray(),n.currentBucket=ko.observable(),n.currentPage=ko.observable(1),n.showLoadMore=ko.observable(!1),n.showAddBucket=ko.observable(!1),n.droppable=ko.observable(!1),n.showInsert=ko.observable(r.length>0),n.canUpload=ko.observable(!0),n.isSearching=ko.observable(!1),n.searchTimeout=null,n.searchTerm=ko.observable(),n.lastSearch=ko.observable(),n.isTrash=ko.observable(!1),n.keymap={ENTER:13,ESC:27},n.__construct=function(){return n.debug("Constructing"),n.init(),n},n.init=function(){var t=new $.Deferred;return t.done(function(){n.debug("Initialisation complete"),n.buckets().length>0?n.listObjects().done(function(){t.resolve(),n.ready(!0)}).fail(function(){}):(t.resolve(),n.ready(!0))}).fail(function(){n.debug("Initialisation failed")}),n.debug("Initialising"),n.listBuckets().done(function(){if(e){n.debug("Initial bucket specified, attempting to load");var r=n.getBucketBySlug(e);if(r)n.debug("Initial bucket is valid, resolving"),n.currentBucket(r.id),t.resolve();else{n.debug("Initial bucket not found, attempting to create");var a=e;a=a.replace(/[_-]/g," "),a=a.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}),$.ajax({url:window.SITE_URL+"api/cdn/bucket",method:"POST",data:{label:a}}).fail(function(){n.debug("Failed to create initial bucket"),t.reject()}).done(function(e){n.debug("Initial bucket created, listing again..."),n.currentBucket(e.data.id),n.listBuckets().done(function(){t.resolve()})})}}else n.buckets().length>0?(n.currentBucket(n.buckets()[0].id),t.resolve()):t.resolve()}),t.promise()},n.addBucket=function(e){n.debug("Adding bucket:"+e.label),n.buckets.push({id:e.id||null,slug:e.slug||null,label:e.label||null,max_size:e.max_size||null,max_size_human:e.max_size_human||null,is_selected:ko.computed(function(){return!n.isSearching()&&!n.isTrash()&&e.id===n.currentBucket()})})},n.selectBucket=function(e){"object"==typeof e?n.currentBucket(e.id):n.currentBucket(e),n.isSearching(!1),n.lastSearch(""),n.searchTerm(""),n.canUpload(!0),n.isTrash(!1),n.currentPage(1),n.objects.removeAll(),n.listObjects()},n.createBucket=function(e,t){return t.which===n.keymap.ENTER?$.ajax({url:window.SITE_URL+"api/cdn/bucket",method:"POST",data:{label:t.currentTarget.value}}).done(function(e){n.showAddBucket(!1),n.listBuckets(),n.selectBucket(e.data.id),n.success("Bucket created")}).fail(function(e){n.error("Failed to create bucket.",e)}):t.which===n.keymap.ESC&&n.showAddBucket(!1),!0},n.uploadObject=function(e,t){return $.each(t.currentTarget.files,function(e,t){var r=n.addObject({label:t.name,is_uploading:!0},!0),a=n.getBucketById(n.currentBucket());if(!a)return r.error("Unable to determine upload bucket."),!1;if(a.max_size&&t.size>a.max_size)return r.error("File is too big; maximum file size for this bucket is "+a.max_size_human),!1;var o=new XMLHttpRequest;o.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=Math.floor(e.loaded/e.total*100);r.upload_progress(t)}},!1),o.addEventListener("error",function(){r.error("An error occurred whilst uploading the file.")},!1),o.addEventListener("load",function(e){if(4===e.currentTarget.readyState){var t;if(200===e.currentTarget.status)try{t=JSON.parse(e.currentTarget.responseText),r.id=t.data.object.id,r.label=t.data.object.object.name,r.ext=r.label.substr(r.label.lastIndexOf(".")+1),r.url={src:t.data.object.url.src,preview:t.data.object.is_img?t.data.object.url["400x400-crop"]:null},r.is_img=t.data.object.is_img,r.is_uploading(!1)}catch(e){t={error:"An unknown error occurred."},r.error(t.error)}else{try{t=JSON.parse(e.currentTarget.responseText)}catch(e){t={error:"An unknown error occurred."}}r.error(t.error)}}},!1),o.open("post",window.SITE_URL+"api/cdn/object/create",!0),o.setRequestHeader("X-Cdn-Bucket",a.slug),o.setRequestHeader("X-Cdn-Urls","400x400-crop");var c=new FormData;c.append("upload",t),o.send(c)}),t.currentTarget.value=null,n.droppable(!1),!0},n.deleteObject=function(){var e=this;if(e.id){var t="Are you sure?";n.isTrash()&&(t+=" You cannot undo this action."),confirm(t)&&$.ajax({url:window.SITE_URL+"api/cdn/object/delete",method:"POST",data:{object_id:e.id}}).done(function(){n.objects.remove(e),n.success("Item deleted")}).fail(function(){n.error("Failed to delete object. It may be in use.")})}else n.objects.remove(e)},n.restoreObject=function(){var e=this;$.ajax({url:window.SITE_URL+"api/cdn/object/restore",method:"POST",data:{object_id:e.id}}).done(function(){n.objects.remove(e),n.success("Item restored")}).fail(function(){n.error("Failed to restore object.")})},n.executeCallback=function(){"ckeditor"===t?(n.callbackCKEditor(this),window.close()):(n.callbackPicker(this),window.parent.$.fancybox.close())},n.callbackCKEditor=function(e){window.opener.CKEDITOR.tools.callFunction(r[0],e.url.src)},n.callbackPicker=function(e){a?window.parent[r[0]][r[1]].call(null,e.id):window.opener[r[0]][r[1]].call(null,e.id)},n.addObject=function(e,t){n.debug("Adding object");var r={id:e.id||null,label:e.label||null,ext:e.ext||null,url:e.url||null,is_img:e.is_img||null,is_uploading:ko.observable(e.is_uploading||!1),upload_progress:ko.observable(0),error:ko.observable()};return t?n.objects.unshift(r):n.objects.push(r),r},n.listBuckets=function(){n.debug("Listing buckets");var e=new $.Deferred;return $.ajax({url:window.SITE_URL+"api/cdn/bucket"}).done(function(t){n.buckets.removeAll(),$.each(t.data,function(e,t){n.addBucket(t)}),e.resolve()}).fail(function(){n.error("Failed to retrieve list of buckets from the server."),e.reject()}),e.promise()},n.getBucketById=function(e){for(var t=0,r=n.buckets().length;t<r;t++)if(n.buckets()[t].id===e)return n.buckets()[t];return null},n.getBucketBySlug=function(e){for(var t=0,r=n.buckets().length;t<r;t++)if(n.buckets()[t].slug===e)return n.buckets()[t];return null},n.listObjects=function(){n.debug("Listing objects");var e,t,r=new $.Deferred;return n.isSearching()?(e=window.SITE_URL+"api/cdn/object/search",t={keywords:n.searchTerm(),page:n.currentPage()}):n.isTrash()?(e=window.SITE_URL+"api/cdn/object/trash",t={page:n.currentPage()}):(e=window.SITE_URL+"api/cdn/bucket/list",t={bucket_id:n.currentBucket(),page:n.currentPage()}),$.ajax({url:e,data:t}).done(function(e){$.each(e.data,function(e,t){n.addObject({id:t.id||null,label:t.file.name.human||null,size:t.file.size.human||null,ext:t.file.ext||null,url:t.url||null,is_img:t.is_img||!1})}),n.currentPage(e.meta.page+1),n.showLoadMore(e.data.length>=e.meta.per_page),r.resolve()}).fail(function(){n.error("Failed to retrieve list of objects from the server."),r.reject()}),r.promise()},n.search=function(){return clearTimeout(n.searchTimeout),n.searchTimeout=setTimeout(function(){var e=$.trim(n.searchTerm());e.length?e!==n.lastSearch()&&(n.isSearching(!0),n.isTrash(!1),n.canUpload(!1),n.lastSearch(e),n.objects.removeAll(),n.currentPage(1),n.listObjects()):n.stopSearch()},150),!0},n.stopSearch=function(){n.isSearching(!1),n.canUpload(!0),n.currentPage(1),n.objects.removeAll(),n.listObjects()},n.browseTrash=function(){n.canUpload(!1),n.isSearching(!1),n.lastSearch(""),n.searchTerm(""),n.isTrash(!0),n.currentPage(1),n.objects.removeAll(),n.listObjects()},n.feedback=function(e,t){n.debug("Feedback: "+e+": "+t);var r=new $.Deferred,a=$(".manager-feedback__"+e);return a.html(t).addClass("show"),setTimeout(function(){n.debug("Closing feedback: "+e),r.resolve(),a.removeClass("show")},2500),r.promise()},n.success=function(e){return n.feedback("success",e)},n.error=function(e){return n.feedback("error",e||"An unknown error occurred.")},n.debug=function(e){return"object"==typeof console&&console.log("[Media Manager] ",e),n},n.__construct()}
//# sourceMappingURL=admin.mediamanager.min.js.map
